<!doctype html>
<html lang="pt-br">
  <head>
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-K9TFCGX9");
    </script>
    <!-- End Google Tag Manager -->

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Affect Ai | Confirmar</title>

    <style>
      :root {
        --purple: #7b73f1;
        --text: #111827;
        --muted: #6b7280;
        --line: #e5e7eb;
        --card: #ffffff;
        --bg1: rgba(123, 115, 241, 0.08);
        --blue: #3b82f6;
        --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }

      body {
        margin: 0;
        font-family: var(--font);
        color: var(--text);
        background:
          radial-gradient(640px 420px at 50% 0%, var(--bg1) 0%, rgba(123,115,241,0.04) 36%, rgba(255,255,255,0) 70%),
          linear-gradient(180deg, #fbfbff 0%, #f3f4f6 48%, #f3f4f6 100%);
        -webkit-font-smoothing: antialiased;
        text-rendering: geometricPrecision;
        overflow-x: hidden;
      }

      .topbar {
        position: sticky;
        top: 0;
        z-index: 50;
        height: 54px;
        background: rgba(255,255,255,0.92);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(229,231,235,0.85);
        display: grid;
        place-items: center;
      }

      .brand {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        color: #111827;
        font-size: 16px;
      }

      .lock {
        width: 22px;
        height: 22px;
        border-radius: 999px;
        border: 1px solid rgba(209,213,219,0.9);
        display: grid;
        place-items: center;
        background: #fff;
      }

      .lock svg { width: 14px; height: 14px; opacity: 0.75; }

      .wrap {
        width: 100%;
        max-width: 720px;
        margin: 0 auto;
        padding: 12px 14px 140px;
      }

      .summary {
        background: rgba(255,255,255,0.7);
        border: 1px solid rgba(229,231,235,0.9);
        border-radius: 14px;
        overflow: hidden;
      }

      .sumRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 14px;
        font-size: 16px;
      }

      .divider { height: 1px; background: rgba(229,231,235,0.9); }

      h1 {
        margin: 18px 2px 14px;
        font-size: 26px;
        line-height: 1.15;
        letter-spacing: -0.02em;
        font-weight: 800;
        color: #111827;
        text-align: center;
      }

      .sectionTitle {
        margin: 16px 2px 10px;
        font-size: 16px;
        font-weight: 800;
        color: #111827;
      }

      .pmCard {
        background: var(--card);
        border: 1px solid rgba(229,231,235,0.9);
        border-radius: 14px;
        padding: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
      }

      .pmLeft {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }

      .visa {
        width: 46px;
        height: 46px;
        border-radius: 999px;
        border: 1px solid rgba(229,231,235,0.9);
        background: #fff;
        display: grid;
        place-items: center;
        font-weight: 900;
        color: #1d4ed8;
        letter-spacing: 0.02em;
      }

      .pmText { min-width: 0; }
      .pmMain {
        font-size: 16px;
        font-weight: 800;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .pmSub {
        font-size: 14px;
        color: rgba(17,24,39,0.55);
        font-weight: 700;
        margin-top: 2px;
      }

      .change {
        border: 0;
        background: transparent;
        color: #3b82f6;
        font-weight: 800;
        font-size: 16px;
        cursor: pointer;
      }

      .helpTitle {
        margin: 18px 2px 6px;
        font-size: 18px;
        font-weight: 800;
        color: #111827;
      }

      .helpSub {
        margin: 0 2px 12px;
        color: rgba(107,114,128,0.95);
        font-size: 14px;
        line-height: 1.35;
        font-weight: 600;
      }

      .emailBox {
        background: var(--card);
        border: 1px solid rgba(229,231,235,0.9);
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
      }

      label {
        display: block;
        font-size: 16px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 10px;
      }

      input {
        width: 100%;
        border: 1px solid rgba(209,213,219,0.95);
        border-radius: 10px;
        padding: 16px 14px;
        font-size: 16px;
        outline: none;
        background: #fff;
        color: #111827;
      }

      input:focus {
        border-color: rgba(59,130,246,0.9);
        box-shadow: 0 0 0 4px rgba(59,130,246,0.14);
      }

      .alert {
        display: none;
        margin-top: 12px;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid rgba(239, 68, 68, 0.35);
        background: rgba(239, 68, 68, 0.06);
        color: #111827;
        font-size: 14px;
        line-height: 1.35;
      }
      .alert.show { display: block; }

      .footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 60;
        background: rgba(255,255,255,0.92);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(229,231,235,0.85);
        padding: 12px 14px calc(14px + env(safe-area-inset-bottom));
      }

      .footerInner {
        max-width: 720px;
        margin: 0 auto;
        display: grid;
        gap: 10px;
        text-align: center;
      }

      .btnPrimary {
        width: 100%;
        border: 0;
        border-radius: 12px;
        padding: 16px 14px;
        font-size: 18px;
        font-weight: 900;
        background: var(--blue);
        color: #fff;
        cursor: pointer;
        box-shadow: 0 16px 28px rgba(59,130,246,0.28);
      }

      .btnPrimary:active { transform: scale(0.99); }

      .btnPrimary[disabled] {
        opacity: 0.7;
        cursor: not-allowed;
        box-shadow: none;
      }

      .footNote {
        font-size: 14px;
        color: rgba(107,114,128,0.95);
        font-weight: 700;
      }

      .money { font-variant-numeric: tabular-nums; }

      @media (min-width: 900px) {
        .wrap { padding-left: 18px; padding-right: 18px; }
      }
    </style>
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-K9TFCGX9"
        height="0"
        width="0"
        style="display:none;visibility:hidden"
      ></iframe>
    </noscript>

    <header class="topbar">
      <div class="brand">
        <span class="lock" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7.5 11V8.8C7.5 6.15 9.6 4 12.2 4c2.6 0 4.7 2.15 4.7 4.8V11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M6.5 11h11a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" />
          </svg>
        </span>
        <span>Affect Ai</span>
      </div>
    </header>

    <main class="wrap">
      <section class="summary" aria-label="Resumo">
        <div class="sumRow">
          <span id="productName">AffectAI Anual</span>
          <strong class="money" id="productPrice">R$ 108,00</strong>
        </div>
        <div class="divider"></div>
        <div class="sumRow">
          <strong>Total</strong>
          <strong class="money" id="totalPrice">108,00</strong>
        </div>
      </section>

      <h1>Confirme a sua assinatura</h1>

      <div class="sectionTitle">Meio de pagamento</div>
      <div class="pmCard" role="group" aria-label="Cartão cadastrado">
        <div class="pmLeft">
          <div class="visa" aria-hidden="true">VISA</div>
          <div class="pmText">
            <div class="pmMain" id="pmMain">Cartão ****</div>
            <div class="pmSub">Visa Crédito</div>
          </div>
        </div>
        <button class="change" id="changeBtn" type="button">Alterar</button>
      </div>

      <div class="helpTitle">Insira seu e-mail</div>
      <p class="helpSub">Você receberá os detalhes do seu pagamento que servirão como comprovante.</p>

      <section class="emailBox" aria-label="E-mail">
        <form id="emailForm">
          <label for="email">E-mail</label>
          <input id="email" name="email" type="email" inputmode="email" autocomplete="email" placeholder="Ex.: nome@email.com" required />
          <div id="alert" class="alert"></div>
        </form>
      </section>
    </main>

    <footer class="footer" aria-label="Ações">
      <div class="footerInner">
        <button class="btnPrimary" id="payBtn" type="submit" form="emailForm">Pagar assinatura</button>
        <div class="footNote">Você pode cancelar quando quiser</div>
      </div>
    </footer>

    <script>
      const CONFIG = {
        BACKEND_ENDPOINT: "https://floral-water-e008.white-king-13b3.workers.dev/api/mp/subscribe",
        BACK_TO_CARD: "/checkout-card.html",
        PLAN_IDS: {
          month: "e9af351c59244681a3cd183596308cf4",
          year: "2bed7dc251154df4a67a026781712a35"
        },
        THANK_YOU: {
          month: "/p9m/",
          year: "/p9a/"
        },
        PRICES: {
          year: { name: "AffectAI Anual", priceText: "R$ 108,00", totalText: "108,00" },
          month: { name: "AffectAI Mensal", priceText: "R$ 27,00", totalText: "27,00" }
        }
      };

      const $ = (id) => document.getElementById(id);

      const form = $("emailForm");
      const emailEl = $("email");
      const alertEl = $("alert");
      const payBtn = $("payBtn");
      const changeBtn = $("changeBtn");

      const productNameEl = $("productName");
      const productPriceEl = $("productPrice");
      const totalPriceEl = $("totalPrice");
      const pmMainEl = $("pmMain");

      function showAlert(msg) {
        alertEl.textContent = msg;
        alertEl.classList.add("show");
      }

      function clearAlert() {
        alertEl.textContent = "";
        alertEl.classList.remove("show");
      }

      function setLoading(on) {
        payBtn.disabled = on;
        payBtn.textContent = on ? "Processando..." : "Pagar assinatura";
      }

      function getPlan() {
        const url = new URL(window.location.href);
        const fromUrl = url.searchParams.get("plan");
        const fromSession = sessionStorage.getItem("affect_plan");
        const fromLocal = localStorage.getItem("affect_plan");
        return fromUrl || fromSession || fromLocal || "year";
      }

      function getToken() {
        return sessionStorage.getItem("affect_card_token") || "";
      }

      function getLast4() {
        return sessionStorage.getItem("affect_card_last4") || "";
      }

      function applySummary(plan) {
        const info = CONFIG.PRICES[plan] || CONFIG.PRICES.year;
        productNameEl.textContent = info.name;
        productPriceEl.textContent = info.priceText;
        totalPriceEl.textContent = info.totalText;
      }

      function applyPaymentMethod() {
        const last4 = getLast4();
        pmMainEl.textContent = last4 ? ("Cartão **** " + last4) : "Cartão ****";
      }

      function goBackToCard(plan) {
        window.location.href = CONFIG.BACK_TO_CARD + "?plan=" + encodeURIComponent(plan || "year");
      }

      changeBtn.addEventListener("click", () => goBackToCard(getPlan()));

      window.addEventListener("load", () => {
        const plan = getPlan();
        sessionStorage.setItem("affect_plan", plan);
        applySummary(plan);
        applyPaymentMethod();

        const token = getToken();
        if (!token) {
          showAlert("Sessão expirou. Volte e preencha os dados do cartão novamente.");
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearAlert();

        const plan = getPlan();
        const token = getToken();
        const payerEmail = emailEl.value.trim();

        if (!payerEmail) return showAlert("Preencha este campo.");
        if (!token) return showAlert("Sessão expirou. Volte e preencha os dados do cartão novamente.");

        const planId = CONFIG.PLAN_IDS[plan];
        if (!planId) return showAlert("Plano inválido.");

        setLoading(true);

        try {
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({ event: "checkout_email_submit", plan });

          const payload = {
            plan,
            preapproval_plan_id: planId,
            payerEmail,
            card_token_id: token
          };

          const res = await fetch(CONFIG.BACKEND_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const out = await res.json().catch(() => ({}));

          if (!res.ok) {
            const msg = out?.message || "Falha ao criar assinatura. Tente novamente.";
            setLoading(false);
            window.dataLayer.push({ event: "checkout_error", plan, message: msg });
            return showAlert(msg);
          }

          window.dataLayer.push({
            event: "subscribe_created",
            plan,
            subscription_id: out.id || "",
            status: out.status || ""
          });

          sessionStorage.removeItem("affect_card_token");

          window.location.href = CONFIG.THANK_YOU[plan] || "/p9a/";
        } catch (err) {
          const msg = err?.message || "Erro inesperado. Tente novamente.";
          setLoading(false);
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({ event: "checkout_error", plan: getPlan(), message: msg });
          showAlert(msg);
        }
      });
    </script>
  </body>
</html>
