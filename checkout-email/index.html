<!doctype html>
<html lang="pt-br">
  <head>
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-K9TFCGX9");
    </script>
    <!-- End Google Tag Manager -->

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Affect Ai | Checkout</title>

    <style>
      :root {
        --purple: #7b73f1;
        --purple2: rgba(123, 115, 241, 0.18);
        --bg: #f5f6fb;
        --text: #0f172a;
        --muted: rgba(15, 23, 42, 0.62);
        --line: rgba(15, 23, 42, 0.10);
        --card: rgba(255, 255, 255, 0.92);
        --shadow: 0 16px 40px rgba(15, 23, 42, 0.10);
        --radius: 16px;
        --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }

      html {
        overflow: hidden;
        overscroll-behavior: none;
        touch-action: none;
      }
      body {
        overflow: hidden;
        overscroll-behavior: none;
        touch-action: none;

        margin: 0;
        font-family: var(--font);
        color: var(--text);
        background:
          radial-gradient(900px 560px at 50% -8%, rgba(123,115,241,.16), rgba(255,255,255,0) 65%),
          radial-gradient(700px 420px at 20% 0%, rgba(123,115,241,.10), rgba(255,255,255,0) 60%),
          var(--bg);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .topline { height: 3px; background: rgba(123,115,241,.85); }
      .wrap { height: calc(100vh - 3px); display: flex; flex-direction: column; }

      .topbar {
        height: 46px;
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: rgba(15,23,42,.75);
        font-weight: 550;
        letter-spacing: 0.01em;
        background: transparent;
      }

      .lock { width: 18px; height: 18px; display: inline-block; opacity: 0.9; }

      .stage {
        width: 100%;
        max-width: 520px;
        margin: 0 auto;
        padding: 12px 14px 22px;
        flex: 1;
        min-height: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .summary {
        margin-top: 6px;
        background: rgba(255,255,255,.84);
        border: 1px solid rgba(15,23,42,.08);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 28px rgba(15,23,42,.06);
        flex: 0 0 auto;
      }

      .sumRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        font-size: 15px;
      }

      .sumRow + .sumRow { border-top: 1px solid rgba(15,23,42,.08); }

      .sumLeft { color: rgba(15,23,42,.72); font-weight: 550; }
      .sumRight { font-weight: 650; color: rgba(15,23,42,.92); }

      h1 {
        margin: 36px 2px 10px;
        font-size: 22px;
        line-height: 1.2;
        letter-spacing: -0.01em;
        font-weight: 550;
        color: rgba(15,23,42,.92);
        text-align: center;
        flex: 0 0 auto;
      }

      .sectionTitle {
        margin: 10px 2px 4px;
        font-size: 14px;
        font-weight: 550;
        color: rgba(15,23,42,.72);
        flex: 0 0 auto;
      }

      .pmCard {
        background: var(--card);
        border: 1px solid rgba(15,23,42,.10);
        border-radius: 16px;
        padding: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        box-shadow: var(--shadow);
        position: relative;
        flex: 0 0 auto;
      }

      .pmCard:before {
        content: "";
        position: absolute;
        inset: -1px;
        border-radius: 16px;
        pointer-events: none;
        border: 1px solid rgba(123,115,241,.28);
        opacity: 0.65;
      }

      .pmLeft { display: flex; align-items: center; gap: 12px; min-width: 0; }

      .brand {
        width: 44px;
        height: 44px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.04);
        border: 1px solid rgba(15,23,42,.10);
        display: grid;
        place-items: center;
        overflow: hidden;
        flex: 0 0 auto;
      }

      .brand img { width: 30px; height: 30px; object-fit: contain; }

      .pmText { display: flex; flex-direction: column; gap: 2px; min-width: 0; }

      .pmMain {
        font-size: 16px;
        font-weight: 650;
        color: rgba(15,23,42,.92);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .pmSub { font-size: 14px; font-weight: 550; color: rgba(15,23,42,.55); }

      .pmRight a { color: rgba(123,115,241,.95); font-weight: 650; text-decoration: none; }
      .pmRight a:active { opacity: 0.85; }

      .helpTitle {
        margin: 28px 2px 6px;
        font-size: 18px;
        font-weight: 650;
        color: rgba(15,23,42,.92);
        flex: 0 0 auto;
      }

      .helpSub {
        margin: 0 2px 12px;
        color: rgba(15,23,42,.62);
        font-size: 14px;
        line-height: 1.35;
        font-weight: 550;
        flex: 0 0 auto;
      }

      .emailBox {
        background: var(--card);
        border: 1px solid rgba(15,23,42,.10);
        border-radius: 16px;
        padding: 14px;
        box-shadow: var(--shadow);
        position: relative;
        flex: 0 0 auto;
      }

      .emailBox:before {
        content: "";
        position: absolute;
        inset: -1px;
        border-radius: 16px;
        pointer-events: none;
        border: 1px solid rgba(123,115,241,.24);
        opacity: 0.55;
      }

      label {
        display: block;
        font-size: 14px;
        font-weight: 550;
        color: rgba(15,23,42,.72);
        margin-bottom: 8px;
      }

      input {
        width: 100%;
        height: 52px;
        border-radius: 12px;
        border: 1px solid rgba(15,23,42,.14);
        padding: 0 14px;
        font-size: 16px;
        outline: none;
        background: rgba(255,255,255,.94);
        color: rgba(15,23,42,.92);
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }

      input::placeholder { color: rgba(15,23,42,.34); }

      input:focus {
        border-color: rgba(123,115,241,.55);
        box-shadow: 0 0 0 4px rgba(123,115,241,.14);
      }

      .btnPrimary {
        margin-top: 16px;
        width: 100%;
        height: 56px;
        background: rgba(123,115,241,.95);
        color: #fff;
        border: 0;
        border-radius: 12px;
        padding: 0 14px;
        font-size: 18px;
        font-weight: 650;
        cursor: pointer;
        box-shadow: 0 18px 38px rgba(123,115,241,.30);
        transition: transform 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease;
        flex: 0 0 auto;
      }

      .btnPrimary:hover {
        transform: translateY(-1px);
        background: rgba(123,115,241,1);
        box-shadow: 0 22px 46px rgba(123,115,241,.36);
      }

      .btnPrimary:active { transform: translateY(0); }

      .btnPrimary[disabled] {
        opacity: 0.7;
        cursor: not-allowed;
        box-shadow: none;
      }

      .alert {
        margin-top: 12px;
        border-radius: 12px;
        padding: 12px 12px;
        font-size: 14px;
        line-height: 1.35;
        display: none;
        border: 1px solid rgba(15,23,42,.10);
        background: rgba(255,255,255,.8);
        flex: 0 0 auto;
      }

      .alert.show { display: block; }

      .alert.bad {
        border-color: rgba(239, 68, 68, 0.28);
        background: rgba(239, 68, 68, 0.08);
        color: rgba(127, 29, 29, 0.92);
      }

      .alert.ok {
        border-color: rgba(34, 197, 94, 0.30);
        background: rgba(34, 197, 94, 0.10);
        color: rgba(20, 83, 45, 0.92);
      }

      .fineprint {
        margin-top: 10px;
        font-size: 14px;
        color: rgba(15,23,42,.42);
        text-align: center;
        font-weight: 550;
        flex: 0 0 auto;
      }

      @media (max-height: 720px) {
        .helpTitle { margin-top: 22px; }
        .stage { padding-bottom: 16px; }
      }
    </style>
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-K9TFCGX9"
        height="0"
        width="0"
        style="display:none;visibility:hidden"
      ></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="topline"></div>

    <div class="wrap">
      <div class="topbar" aria-label="Affect Ai">
        <svg class="lock" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7.5 11V8.8a4.5 4.5 0 0 1 9 0V11" stroke="rgba(15,23,42,.6)" stroke-width="2" stroke-linecap="round" />
          <path d="M6.5 11h11a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2Z" stroke="rgba(15,23,42,.6)" stroke-width="2" />
        </svg>
        <span>Affect Ai</span>
      </div>

      <main class="stage">
        <div class="summary" aria-label="Resumo">
          <div class="sumRow">
            <div class="sumLeft" id="productName">AffectAI Anual</div>
            <div class="sumRight" id="productPrice">R$ 108,00</div>
          </div>
          <div class="sumRow">
            <div class="sumLeft">Total</div>
            <div class="sumRight" id="totalPrice">108,00</div>
          </div>
        </div>

        <h1>Confirme a sua assinatura</h1>

        <div class="sectionTitle">Meio de pagamento</div>
        <div class="pmCard" aria-label="Meio de pagamento">
          <div class="pmLeft">
            <div class="brand" id="brandBox" aria-hidden="true"></div>
            <div class="pmText">
              <div class="pmMain" id="pmMain">Cartão ****</div>
              <div class="pmSub" id="pmSub">Crédito</div>
            </div>
          </div>
          <div class="pmRight">
            <a href="/checkout" id="changeLink">Alterar</a>
          </div>
        </div>

        <div class="helpTitle">Insira seu e-mail</div>
        <div class="helpSub">Você receberá os detalhes do seu pagamento que servirão como comprovante.</div>

        <div class="emailBox" aria-label="E-mail">
          <label for="email">E-mail</label>
          <input id="email" name="email" type="email" inputmode="email" autocomplete="email" placeholder="Ex.: nome@email.com" required />
        </div>

        <button class="btnPrimary" id="payBtn" type="button">Pagar assinatura</button>

        <div id="alert" class="alert"></div>

        <div class="fineprint">Você pode cancelar quando quiser</div>
      </main>
    </div>

    <script>
      const CONFIG = {
        BACKEND_ENDPOINT: "https://floral-water-e008.white-king-13b3.workers.dev/api/mp/subscribe",
        PLAN_IDS: {
          month: "e9af351c59244681a3cd183596308cf4",
          year: "2bed7dc251154df4a67a026781712a35"
        },
        THANK_YOU: {
          month: "/p9m/",
          year: "/p9a/"
        },
        PLAN_META: {
          month: { name: "AffectAI Mensal", displayPrice: "R$ 27,00", total: "27,00" },
          year: { name: "AffectAI Anual", displayPrice: "R$ 108,00", total: "108,00" }
        }
      };

      const $ = (id) => document.getElementById(id);

      const productNameEl = $("productName");
      const productPriceEl = $("productPrice");
      const totalPriceEl = $("totalPrice");

      const brandBox = $("brandBox");
      const pmMainEl = $("pmMain");
      const pmSubEl = $("pmSub");

      const emailEl = $("email");
      const payBtn = $("payBtn");
      const alertEl = $("alert");

      function showAlert(type, msg) {
        alertEl.className = "alert show " + type;
        alertEl.textContent = msg;
      }

      function clearAlert() {
        alertEl.className = "alert";
        alertEl.textContent = "";
      }

      function safeJsonParse(s) {
        try { return JSON.parse(s); } catch { return null; }
      }

      function getPlan() {
        const plan = sessionStorage.getItem("affectai_plan_final")
          || sessionStorage.getItem("affectai_plan")
          || "year";
        return plan === "month" ? "month" : "year";
      }

      const plan = getPlan();

      const meta = CONFIG.PLAN_META[plan] || CONFIG.PLAN_META.year;
      productNameEl.textContent = meta.name;
      productPriceEl.textContent = meta.displayPrice;
      totalPriceEl.textContent = meta.total;

      const token = sessionStorage.getItem("affectai_token") || "";
      const last4 = sessionStorage.getItem("affectai_last4") || "";
      const planIdStored = sessionStorage.getItem("affectai_plan_id") || "";
      const pmRaw = sessionStorage.getItem("affectai_pm") || "";
      const pm = pmRaw ? safeJsonParse(pmRaw) : null;

      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({ event: "checkout_email_view", plan });

      if (!token) {
        showAlert("bad", "Sessão expirou. Volte e preencha os dados do cartão novamente.");
        payBtn.disabled = true;
      }

      pmMainEl.textContent = last4 ? ("Cartão Mercado **** " + last4) : "Cartão ****";
      pmSubEl.textContent = pm && pm.name ? (pm.name + " Crédito") : "Crédito";

      if (pm && pm.thumbnail) {
        const img = document.createElement("img");
        img.src = pm.thumbnail;
        img.alt = "";
        brandBox.innerHTML = "";
        brandBox.appendChild(img);
      } else {
        brandBox.textContent = "MP";
        brandBox.style.fontWeight = "650";
        brandBox.style.color = "rgba(123,115,241,.95)";
      }

      async function submit() {
        clearAlert();

        const payerEmail = (emailEl.value || "").trim();
        if (!payerEmail) return showAlert("bad", "Preencha este campo.");

        const preapproval_plan_id = planIdStored || CONFIG.PLAN_IDS[plan];
        if (!preapproval_plan_id) return showAlert("bad", "Plano inválido.");

        payBtn.disabled = true;

        try {
          window.dataLayer.push({ event: "checkout_email_submit", plan });

          const payload = {
            plan,
            preapproval_plan_id,
            payerEmail,
            card_token_id: token
          };

          const res = await fetch(CONFIG.BACKEND_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const out = await res.json().catch(() => ({}));

          if (!res.ok) {
            const msg = out && out.message ? out.message : "Falha ao criar assinatura. Tente novamente.";
            window.dataLayer.push({ event: "checkout_error", plan, step: "email", message: msg });
            payBtn.disabled = false;
            return showAlert("bad", msg);
          }

          window.dataLayer.push({
            event: "subscribe_created",
            plan,
            subscription_id: out.id || "",
            status: out.status || ""
          });

          showAlert("ok", "Assinatura criada.");

          sessionStorage.removeItem("affectai_token");

          setTimeout(() => {
            window.location.href = CONFIG.THANK_YOU[plan] || "/p9a/";
          }, 300);
        } catch (err) {
          const msg = err && err.message ? err.message : "Erro inesperado. Tente novamente.";
          window.dataLayer.push({ event: "checkout_error", plan, step: "email", message: msg });
          payBtn.disabled = false;
          showAlert("bad", msg);
        }
      }

      payBtn.addEventListener("click", submit);
      emailEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          submit();
        }
      });
    </script>
  </body>
</html>
