<!doctype html>
<html lang="pt-br">
  <head>
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-K9TFCGX9");
    </script>
    <!-- End Google Tag Manager -->

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Affect AI | E-mail</title>

    <style>
      :root {
        --purple: #7b73f1;
        --bg: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }

      body {
        margin: 0;
        font-family: var(--font);
        background: #f3f4f6;
        color: var(--text);
        overflow: hidden;
        overscroll-behavior: none;
        touch-action: none;
      }

      .stage {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 18px 16px;
      }

      .column {
        width: 100%;
        max-width: 520px;
      }

      .title {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 12px;
        color: #111827;
      }

      .card {
        background: #fff;
        border-radius: 10px;
        padding: 18px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
      }

      label {
        font-size: 13px;
        font-weight: 600;
        color: #111827;
        display: block;
        margin-bottom: 10px;
      }

      input {
        width: 100%;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        padding: 14px 12px;
        font-size: 15px;
        outline: none;
        background: #fff;
        color: #111827;
      }

      input:focus {
        border-color: rgba(123, 115, 241, 0.85);
        box-shadow: 0 0 0 3px rgba(123, 115, 241, 0.14);
      }

      .actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 18px;
      }

      .btn {
        border: 0;
        border-radius: 8px;
        padding: 12px 18px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
      }

      .btn.secondary {
        background: #e5e7eb;
        color: #111827;
      }

      .btn.primary {
        background: var(--purple);
        color: #fff;
      }

      .btn[disabled] {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .alert {
        margin-top: 12px;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        display: none;
        border: 1px solid #e5e7eb;
        background: #fff;
      }

      .alert.show { display: block; }
      .alert.bad { border-color: rgba(239, 68, 68, 0.35); background: rgba(239, 68, 68, 0.06); }
      .alert.ok { border-color: rgba(34, 197, 94, 0.35); background: rgba(34, 197, 94, 0.08); }

      .fineprint {
        margin-top: 10px;
        font-size: 13px;
        color: rgba(107, 114, 128, 0.9);
      }
    </style>
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-K9TFCGX9"
        height="0"
        width="0"
        style="display:none;visibility:hidden"
      ></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <main class="stage">
      <div class="column">
        <h1 class="title">Informe seu e-mail</h1>

        <section class="card">
          <form id="emailForm">
            <label for="email">E-mail</label>
            <input
              id="email"
              name="email"
              type="email"
              inputmode="email"
              autocomplete="email"
              placeholder="seuemail@exemplo.com"
              required
            />

            <div class="actions">
              <button type="button" class="btn secondary" id="backBtn">Voltar</button>
              <button type="submit" class="btn primary" id="payBtn">Assinar agora</button>
            </div>

            <div id="alert" class="alert"></div>
            <div class="fineprint">Garantia de 14 dias. Cancele quando quiser.</div>
          </form>
        </section>
      </div>
    </main>

    <script>
      const CONFIG = {
        BACKEND_ENDPOINT: "https://floral-water-e008.white-king-13b3.workers.dev/api/mp/subscribe",
        PLAN_IDS: {
          month: "e9af351c59244681a3cd183596308cf4",
          year: "2bed7dc251154df4a67a026781712a35"
        },
        THANK_YOU: {
          month: "/p9m/",
          year: "/p9a/"
        },
        BACK_TO_CARD: "/checkout-card.html"
      };

      const $ = (id) => document.getElementById(id);

      const form = $("emailForm");
      const emailEl = $("email");
      const alertEl = $("alert");
      const payBtn = $("payBtn");
      const backBtn = $("backBtn");

      function showAlert(type, msg) {
        alertEl.className = "alert show " + type;
        alertEl.textContent = msg;
      }
      function clearAlert() {
        alertEl.className = "alert";
        alertEl.textContent = "";
      }
      function setLoading(on) {
        payBtn.disabled = on;
        payBtn.textContent = on ? "Processando..." : "Assinar agora";
      }

      function getPlan() {
        const url = new URL(window.location.href);
        const fromUrl = url.searchParams.get("plan");
        const fromSession = sessionStorage.getItem("affect_plan");
        const fromLocal = localStorage.getItem("affect_plan");
        return fromUrl || fromSession || fromLocal || "year";
      }

      function getToken() {
        return sessionStorage.getItem("affect_card_token") || "";
      }

      function goBackToCard(plan) {
        window.location.href = CONFIG.BACK_TO_CARD + "?plan=" + encodeURIComponent(plan || "year");
      }

      backBtn.addEventListener("click", () => {
        const plan = getPlan();
        goBackToCard(plan);
      });

      window.addEventListener("load", () => {
        const plan = getPlan();
        const token = getToken();
        if (!token) {
          showAlert("bad", "Sessão expirou. Volte e preencha os dados do cartão novamente.");
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({ event: "checkout_email_missing_token", plan });
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearAlert();

        const plan = getPlan();
        const token = getToken();
        const payerEmail = emailEl.value.trim();

        if (!payerEmail) return showAlert("bad", "Preencha o e-mail.");
        if (!token) return showAlert("bad", "Sessão expirou. Volte e preencha os dados do cartão novamente.");

        const planId = CONFIG.PLAN_IDS[plan];
        if (!planId) return showAlert("bad", "Plano inválido.");

        setLoading(true);

        try {
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({ event: "checkout_email_submit", plan });

          const payload = {
            plan,
            preapproval_plan_id: planId,
            payerEmail,
            card_token_id: token
          };

          const res = await fetch(CONFIG.BACKEND_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const out = await res.json().catch(() => ({}));

          if (!res.ok) {
            const msg = out?.message || "Falha ao criar assinatura. Tente novamente.";
            window.dataLayer.push({ event: "checkout_error", plan, message: msg });
            setLoading(false);
            return showAlert("bad", msg);
          }

          window.dataLayer.push({
            event: "subscribe_created",
            plan,
            subscription_id: out.id || "",
            status: out.status || ""
          });

          showAlert("ok", "Assinatura criada. Redirecionando...");
          sessionStorage.removeItem("affect_card_token");

          setTimeout(() => {
            window.location.href = CONFIG.THANK_YOU[plan] || "/p9a/";
          }, 450);
        } catch (err) {
          const msg = err?.message || "Erro inesperado. Tente novamente.";
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({ event: "checkout_error", plan, message: msg });
          setLoading(false);
          showAlert("bad", msg);
        }
      });

      window.addEventListener("touchmove", (e) => e.preventDefault(), { passive: false });
      window.addEventListener("wheel", (e) => e.preventDefault(), { passive: false });
    </script>
  </body>
</html>
