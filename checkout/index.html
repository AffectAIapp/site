<!doctype html>
<html lang="pt-br">
  <head>
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-K9TFCGX9");
    </script>
    <!-- End Google Tag Manager -->

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Affect AI | Checkout</title>

    <script src="https://sdk.mercadopago.com/js/v2"></script>

    <style>
      :root {
        --purple: #7b73f1;

        --bg: #f3f4f6;
        --card: #ffffff;

        --text: #111827;
        --muted: #6b7280;

        --line: #e5e7eb;
        --lineStrong: #d1d5db;

        --danger: #ef4444;

        --primaryBtn: #2563eb;
        --secondaryBtnBg: #e5e7eb;
        --secondaryBtnText: #2563eb;

        --shadow: 0 16px 30px rgba(15, 23, 42, 0.12);
        --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: var(--font);
        color: var(--text);
        background: var(--bg);
        overflow: hidden;
        overscroll-behavior: none;
        touch-action: none;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: geometricPrecision;
      }

      .page {
        height: 100vh;
        max-width: 520px;
        margin: 0 auto;
        padding: 14px 14px 12px;
        display: grid;
        grid-template-rows: auto auto 1fr auto;
        gap: 10px;
      }

      h1 {
        margin: 6px 0 0;
        font-size: 22px;
        font-weight: 900;
        letter-spacing: -0.01em;
        text-align: center;
      }

      .subtitle {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
        line-height: 1.2;
        text-align: center;
      }

      .plans {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .plan {
        background: var(--card);
        border: 1.5px solid var(--line);
        border-radius: 16px;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
      }

      .plan.selected {
        background: #f7f7ff;
        border-color: rgba(123, 115, 241, 0.55);
        box-shadow: 0 12px 28px rgba(123, 115, 241, 0.10);
      }

      .plan-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
        align-items: flex-start;
        text-align: left;
      }

      .plan-top {
        font-weight: 700;
        color: rgba(17, 24, 39, 0.60);
        font-size: 14px;
        line-height: 1.1;
      }

      .price-row {
        display: flex;
        align-items: baseline;
        gap: 6px;
      }

      .price {
        font-size: 28px;
        font-weight: 900;
        letter-spacing: -0.01em;
        color: var(--text);
        line-height: 1.05;
      }

      .per {
        font-size: 14px;
        color: rgba(17, 24, 39, 0.55);
        font-weight: 600;
      }

      .note {
        font-size: 13px;
        color: rgba(107, 114, 128, 0.85);
        line-height: 1.1;
      }

      .plan-right {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
      }

      .badge {
        font-size: 12px;
        font-weight: 800;
        color: #16a34a;
        background: rgba(34, 197, 94, 0.14);
        padding: 6px 10px;
        border-radius: 999px;
        white-space: nowrap;
      }

      .radio {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 2px solid #cbd5e1;
        display: grid;
        place-items: center;
      }

      .plan.selected .radio {
        border-color: rgba(123, 115, 241, 0.9);
      }

      .dot {
        width: 9px;
        height: 9px;
        border-radius: 999px;
        background: transparent;
      }

      .plan.selected .dot {
        background: rgba(123, 115, 241, 1);
      }

      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 12px;
        align-self: center;
      }

      .field {
        margin: 0 0 10px;
      }

      .label {
        display: block;
        font-size: 13px;
        font-weight: 800;
        color: var(--text);
        margin: 0 0 6px;
      }

      .control {
        position: relative;
      }

      input,
      select {
        width: 100%;
        border-radius: 10px;
        border: 1.5px solid var(--lineStrong);
        padding: 12px 12px;
        font-size: 14px;
        outline: none;
        background: #fff;
        color: var(--text);
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }

      input::placeholder {
        color: #9ca3af;
      }

      input:focus,
      select:focus {
        border-color: rgba(123, 115, 241, 0.9);
        box-shadow: 0 0 0 4px rgba(123, 115, 241, 0.12);
      }

      .helper {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.2;
      }

      .error {
        margin-top: 6px;
        font-size: 12px;
        color: var(--danger);
        display: none;
        align-items: center;
        gap: 6px;
      }

      .error svg {
        width: 14px;
        height: 14px;
        flex: 0 0 14px;
      }

      .invalid .label {
        color: var(--danger);
      }

      .invalid input,
      .invalid select {
        border-color: var(--danger);
        box-shadow: none;
      }

      .invalid .error {
        display: inline-flex;
      }

      .two {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .docRow {
        display: grid;
        grid-template-columns: 92px 1fr;
        gap: 10px;
      }

      .actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        align-items: center;
      }

      .btn {
        width: 100%;
        border-radius: 10px;
        padding: 12px 12px;
        font-size: 14px;
        font-weight: 900;
        cursor: pointer;
        border: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn.secondary {
        background: var(--secondaryBtnBg);
        color: var(--secondaryBtnText);
      }

      .btn.primary {
        background: var(--primaryBtn);
        color: #fff;
      }

      .btn[disabled] {
        opacity: 0.75;
        cursor: not-allowed;
      }

      .spinner {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.35);
        border-top-color: rgba(255, 255, 255, 0.95);
        animation: spin 0.9s linear infinite;
        display: none;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .secureRow {
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: rgba(107, 114, 128, 0.78);
        font-size: 13px;
        font-weight: 700;
      }

      .secureRow svg {
        width: 18px;
        height: 18px;
        flex: 0 0 18px;
      }

      .alert {
        margin-top: 10px;
        border-radius: 10px;
        padding: 10px 10px;
        font-size: 13px;
        line-height: 1.25;
        display: none;
        border: 1px solid var(--line);
        background: #fff;
        text-align: left;
      }

      .alert.show {
        display: block;
      }

      .alert.ok {
        border-color: rgba(34, 197, 94, 0.35);
        background: rgba(34, 197, 94, 0.08);
      }

      .alert.bad {
        border-color: rgba(239, 68, 68, 0.35);
        background: rgba(239, 68, 68, 0.06);
      }

      .fineprint {
        text-align: center;
        margin: 0;
        font-size: 13px;
        color: rgba(107, 114, 128, 0.72);
      }

      /* Compactação para caber sem scroll */
      @media (max-height: 760px) {
        .page {
          padding-top: 10px;
          gap: 8px;
        }
        .plans {
          gap: 8px;
        }
        .plan {
          padding: 10px 12px;
        }
        .price {
          font-size: 26px;
        }
        .card {
          padding: 10px;
        }
        .field {
          margin-bottom: 8px;
        }
        input,
        select {
          padding: 10px 10px;
        }
        .helper {
          margin-top: 5px;
        }
      }
    </style>
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-K9TFCGX9"
        height="0"
        width="0"
        style="display:none;visibility:hidden"
      ></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <main class="page" id="stage">
      <div>
        <h1>Comece agora.</h1>
        <p class="subtitle">Preencha os dados do seu cartão</p>
      </div>

      <section class="plans" aria-label="Planos">
        <div class="plan selected" role="button" tabindex="0" data-plan="year" aria-pressed="true">
          <div class="plan-left">
            <div class="plan-top">1 ano</div>
            <div class="price-row">
              <div class="price">R$ 9</div>
              <div class="per">/ mês</div>
            </div>
            <div class="note">R$ 108 por ano</div>
          </div>

          <div class="plan-right">
            <div class="badge">Desconto</div>
            <div class="radio" aria-hidden="true"><div class="dot"></div></div>
          </div>
        </div>

        <div class="plan" role="button" tabindex="0" data-plan="month" aria-pressed="false">
          <div class="plan-left">
            <div class="plan-top">1 mês</div>
            <div class="price-row">
              <div class="price">R$ 27</div>
              <div class="per">/ mês</div>
            </div>
          </div>

          <div class="plan-right">
            <div class="radio" aria-hidden="true"><div class="dot"></div></div>
          </div>
        </div>
      </section>

      <section class="card" aria-label="Dados do cartão">
        <form id="checkoutForm" novalidate>
          <div class="field" id="fCardNumber">
            <span class="label">Número do cartão</span>
            <div class="control">
              <input
                id="cardNumber"
                type="text"
                inputmode="numeric"
                autocomplete="cc-number"
                placeholder="1234 1234 1234 1234"
                required
              />
            </div>
            <div class="error">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 8v5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
                <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M10.2 4.6h3.6L21 12l-7.2 7.4h-3.6L3 12l7.2-7.4Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
              </svg>
              <span>Preencha este campo.</span>
            </div>
          </div>

          <div class="field" id="fName">
            <span class="label">Nome do titular</span>
            <div class="control">
              <input
                id="cardholderName"
                type="text"
                autocomplete="cc-name"
                placeholder="Ex.: Maria Lopes"
                required
              />
            </div>
            <div class="helper">Conforme aparece no cartão.</div>
            <div class="error">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 8v5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
                <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M10.2 4.6h3.6L21 12l-7.2 7.4h-3.6L3 12l7.2-7.4Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
              </svg>
              <span>Preencha este campo.</span>
            </div>
          </div>

          <div class="two">
            <div class="field" id="fExp">
              <span class="label">Vencimento</span>
              <div class="control">
                <input
                  id="expiration"
                  type="text"
                  inputmode="numeric"
                  autocomplete="cc-exp"
                  placeholder="MM/AA"
                  required
                />
              </div>
              <div class="error">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M12 8v5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
                  <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                  <path d="M10.2 4.6h3.6L21 12l-7.2 7.4h-3.6L3 12l7.2-7.4Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                </svg>
                <span>Preencha este campo.</span>
              </div>
            </div>

            <div class="field" id="fCvv">
              <span class="label">Código de segurança</span>
              <div class="control">
                <input
                  id="cvv"
                  type="password"
                  inputmode="numeric"
                  autocomplete="cc-csc"
                  placeholder="Ex.: 123"
                  required
                />
              </div>
              <div class="error">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M12 8v5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
                  <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                  <path d="M10.2 4.6h3.6L21 12l-7.2 7.4h-3.6L3 12l7.2-7.4Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                </svg>
                <span>Preencha este campo.</span>
              </div>
            </div>
          </div>

          <div class="field" id="fDoc">
            <span class="label">Documento do titular</span>
            <div class="docRow">
              <select id="docType" required>
                <option value="CPF">CPF</option>
                <option value="CNPJ">CNPJ</option>
              </select>
              <input id="docNumber" type="text" inputmode="numeric" autocomplete="off" placeholder="999.999.999-99" required />
            </div>
            <div class="error">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 8v5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
                <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M10.2 4.6h3.6L21 12l-7.2 7.4h-3.6L3 12l7.2-7.4Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
              </svg>
              <span>Preencha este campo.</span>
            </div>
          </div>

          <div class="field" id="fEmail">
            <span class="label">E-mail</span>
            <div class="control">
              <input
                id="email"
                type="email"
                inputmode="email"
                autocomplete="email"
                placeholder="seuemail@exemplo.com"
                required
              />
            </div>
            <div class="error">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 8v5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
                <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M10.2 4.6h3.6L21 12l-7.2 7.4h-3.6L3 12l7.2-7.4Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
              </svg>
              <span>Preencha este campo.</span>
            </div>
          </div>

          <div class="secureRow" aria-label="Selo de segurança">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 2 20 6v6c0 5-3.5 9.5-8 10-4.5-.5-8-5-8-10V6l8-4Z" stroke="rgba(34,197,94,.9)" stroke-width="2" stroke-linejoin="round" />
              <path d="M9.5 12.5l1.7 1.7 3.6-3.8" stroke="rgba(34,197,94,.9)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span>Pagamento 100% seguro</span>
          </div>

          <div class="actions">
            <button class="btn secondary" type="button" id="btnBack">Voltar</button>
            <button class="btn primary" type="submit" id="btnPay">
              <span id="btnText">Assinar agora</span>
              <span id="btnSpin" class="spinner" aria-hidden="true"></span>
            </button>
          </div>

          <div id="alert" class="alert"></div>
        </form>
      </section>

      <p class="fineprint">Garantia de 14 dias. Cancele quando quiser.</p>
    </main>

    <script>
      const CONFIG = {
        MP_PUBLIC_KEY: "APP_USR-6c3829de-de42-45c0-9689-cd002aaf558b",
        BACKEND_ENDPOINT: "https://floral-water-e008.white-king-13b3.workers.dev/api/mp/subscribe",
        PLAN_IDS: {
          month: "e9af351c59244681a3cd183596308cf4",
          year: "2bed7dc251154df4a67a026781712a35"
        },
        THANK_YOU: {
          month: "/p9m/",
          year: "/p9a/"
        }
      };

      const $ = (id) => document.getElementById(id);

      const form = $("checkoutForm");
      const btnBack = $("btnBack");
      const btnPay = $("btnPay");
      const btnText = $("btnText");
      const btnSpin = $("btnSpin");
      const alertEl = $("alert");

      const cardNumberEl = $("cardNumber");
      const nameEl = $("cardholderName");
      const expEl = $("expiration");
      const cvvEl = $("cvv");
      const docTypeEl = $("docType");
      const docEl = $("docNumber");
      const emailEl = $("email");

      let currentPlan = "year";

      function onlyDigits(s) {
        return (s || "").replace(/\D+/g, "");
      }

      function setLoading(on) {
        btnPay.disabled = on;
        btnSpin.style.display = on ? "inline-block" : "none";
        btnText.textContent = on ? "Processando..." : "Assinar agora";
      }

      function showAlert(type, msg) {
        alertEl.className = "alert show " + type;
        alertEl.textContent = msg;
      }

      function clearAlert() {
        alertEl.className = "alert";
        alertEl.textContent = "";
      }

      function setInvalid(fieldId, on) {
        const el = $(fieldId);
        if (!el) return;
        el.classList.toggle("invalid", !!on);
      }

      function validateBasic() {
        let ok = true;

        const cn = onlyDigits(cardNumberEl.value);
        const nm = nameEl.value.trim();
        const ex = expEl.value.trim();
        const cv = onlyDigits(cvvEl.value);
        const dc = onlyDigits(docEl.value);
        const em = emailEl.value.trim();

        setInvalid("fCardNumber", !cn);
        setInvalid("fName", !nm);
        setInvalid("fExp", !ex);
        setInvalid("fCvv", !cv);
        setInvalid("fDoc", !dc);
        setInvalid("fEmail", !em);

        if (!cn || !nm || !ex || !cv || !dc || !em) ok = false;

        return ok;
      }

      function formatCardNumber(v) {
        const d = onlyDigits(v).slice(0, 19);
        const parts = [];
        for (let i = 0; i < d.length; i += 4) parts.push(d.slice(i, i + 4));
        return parts.join(" ");
      }

      function formatExpiration(v) {
        const d = onlyDigits(v).slice(0, 4);
        if (d.length <= 2) return d;
        return d.slice(0, 2) + "/" + d.slice(2);
      }

      cardNumberEl.addEventListener("input", (e) => {
        e.target.value = formatCardNumber(e.target.value);
        setInvalid("fCardNumber", false);
      });

      expEl.addEventListener("input", (e) => {
        e.target.value = formatExpiration(e.target.value);
        setInvalid("fExp", false);
      });

      cvvEl.addEventListener("input", () => setInvalid("fCvv", false));
      nameEl.addEventListener("input", () => setInvalid("fName", false));
      emailEl.addEventListener("input", () => setInvalid("fEmail", false));

      function docMax() {
        return docTypeEl.value === "CPF" ? 11 : 14;
      }

      function docPlaceholder() {
        return docTypeEl.value === "CPF" ? "999.999.999-99" : "99.999.999/9999-99";
      }

      docTypeEl.addEventListener("change", () => {
        docEl.value = onlyDigits(docEl.value).slice(0, docMax());
        docEl.placeholder = docPlaceholder();
        setInvalid("fDoc", false);
      });

      docEl.placeholder = docPlaceholder();

      docEl.addEventListener("input", (e) => {
        e.target.value = onlyDigits(e.target.value).slice(0, docMax());
        setInvalid("fDoc", false);
      });

      function setPlan(plan) {
        currentPlan = plan;

        document.querySelectorAll(".plan").forEach((el) => {
          const selected = el.dataset.plan === plan;
          el.classList.toggle("selected", selected);
          el.setAttribute("aria-pressed", selected ? "true" : "false");
        });

        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({ event: "checkout_plan_selected", plan });
      }

      document.querySelectorAll(".plan").forEach((el) => {
        el.addEventListener("click", () => setPlan(el.dataset.plan));
        el.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter" || ev.key === " ") {
            ev.preventDefault();
            setPlan(el.dataset.plan);
          }
        });
      });

      btnBack.addEventListener("click", () => history.back());

      const mp = new MercadoPago(CONFIG.MP_PUBLIC_KEY, { locale: "pt-BR" });

      function parseExp(mmYY) {
        const clean = onlyDigits(mmYY);
        const mm = clean.slice(0, 2);
        const yy = clean.slice(2, 4);
        if (mm.length !== 2 || yy.length !== 2) return null;
        const month = Number(mm);
        if (Number.isNaN(month) || month < 1 || month > 12) return null;
        const year = 2000 + Number(yy);
        return { month: String(month), year: String(year) };
      }

      async function createCardToken() {
        const exp = parseExp(expEl.value);
        if (!exp) throw new Error("Validade inválida. Use MM/AA.");

        const result = await mp.createCardToken({
          cardNumber: onlyDigits(cardNumberEl.value),
          cardholderName: nameEl.value.trim(),
          cardExpirationMonth: exp.month,
          cardExpirationYear: exp.year,
          securityCode: onlyDigits(cvvEl.value),
          identificationType: docTypeEl.value,
          identificationNumber: onlyDigits(docEl.value)
        });

        if (result?.error) {
          const msg = result?.error?.message || "Não foi possível validar o cartão.";
          throw new Error(msg);
        }

        const token = result?.id;
        if (!token) throw new Error("Token não gerado. Revise os dados do cartão.");
        return token;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearAlert();

        if (!validateBasic()) return;

        const planId = CONFIG.PLAN_IDS[currentPlan];
        if (!planId) return showAlert("bad", "Plano inválido.");

        setLoading(true);

        try {
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({ event: "checkout_submit", plan: currentPlan });

          const card_token_id = await createCardToken();

          const payload = {
            plan: currentPlan,
            preapproval_plan_id: planId,
            payerEmail: emailEl.value.trim(),
            card_token_id
          };

          const res = await fetch(CONFIG.BACKEND_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const out = await res.json().catch(() => ({}));

          if (!res.ok) {
            const msg = out?.message || "Falha ao criar assinatura. Tente novamente.";
            window.dataLayer.push({ event: "checkout_error", plan: currentPlan, message: msg });
            setLoading(false);
            return showAlert("bad", msg);
          }

          window.dataLayer.push({
            event: "subscribe_created",
            plan: currentPlan,
            subscription_id: out.id || "",
            status: out.status || ""
          });

          showAlert("ok", "Assinatura criada. Redirecionando...");

          setTimeout(() => {
            window.location.href = CONFIG.THANK_YOU[currentPlan] || "/p9a/";
          }, 300);
        } catch (err) {
          const msg = err?.message || "Erro inesperado. Tente novamente.";
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({ event: "checkout_error", plan: currentPlan, message: msg });
          setLoading(false);
          showAlert("bad", msg);
        }
      });

      window.addEventListener("touchmove", (e) => e.preventDefault(), { passive: false });
      window.addEventListener("wheel", (e) => e.preventDefault(), { passive: false });
    </script>
  </body>
</html>
```
