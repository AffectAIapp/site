```html
<!doctype html>
<html lang="pt-br">
  <head>
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-K9TFCGX9");
    </script>
    <!-- End Google Tag Manager -->

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Affect Ai | Cartão</title>

    <script src="https://sdk.mercadopago.com/js/v2"></script>

    <style>
      :root {
        --purple: #7b73f1;
        --purple2: rgba(123, 115, 241, 0.18);
        --bg: #f5f6fb;
        --text: #0f172a;
        --muted: rgba(15, 23, 42, 0.62);
        --line: rgba(15, 23, 42, 0.10);
        --card: rgba(255, 255, 255, 0.92);
        --shadow: 0 16px 40px rgba(15, 23, 42, 0.10);
        --radius: 16px;
        --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial;
      }

      * { box-sizing: border-box; }

      html, body { height: 100%; }

      /* trava scroll no mobile (inclui iOS) */
      html, body{
        height: 100%;
        overflow: hidden;
      }
      html{
        overscroll-behavior: none;
      }
      body{
        overscroll-behavior: none;
        touch-action: manipulation;
      }

      body {
        margin: 0;
        font-family: var(--font);
        color: var(--text);
        background:
          radial-gradient(900px 560px at 50% -8%, rgba(123,115,241,.16), rgba(255,255,255,0) 65%),
          radial-gradient(700px 420px at 20% 0%, rgba(123,115,241,.10), rgba(255,255,255,0) 60%),
          var(--bg);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .topline {
        height: 3px;
        background: rgba(123,115,241,.85);
      }

      .wrap {
        min-height: calc(100svh - 3px);
        padding: 12px 14px 20px;
        display: flex;
        justify-content: center;
      }

      .phone {
        width: 100%;
        max-width: 420px;
      }

      .nav {
        height: 46px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: rgba(15,23,42,.75);
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .lock {
        width: 18px;
        height: 18px;
        opacity: 0.9;
      }

      .summary {
        margin-top: 6px;
        background: rgba(255,255,255,.84);
        border: 1px solid rgba(15,23,42,.08);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 28px rgba(15,23,42,.06);
      }

      .summaryRow {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 14px;
        font-size: 16px;
        color: rgba(15,23,42,.84);
      }

      .summaryRow strong {
        font-weight: 700;
        color: rgba(15,23,42,.92);
      }

      .divider {
        height: 1px;
        background: rgba(15,23,42,.08);
      }

      .title {
        margin: 24px 2px 12px;
        font-size: 22px;
        line-height: 1.15;
        letter-spacing: -0.015em;
        font-weight: 600;
        color: rgba(15,23,42,.92);
      }

      .card {
        background: var(--card);
        border: 1px solid rgba(15,23,42,.10);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 14px;
        position: relative;
      }

      .card:before {
        content: "";
        position: absolute;
        inset: -1px;
        border-radius: 16px;
        pointer-events: none;
        border: 1px solid rgba(123,115,241,.28);
        opacity: 0.65;
      }

      .field {
        margin-bottom: 14px;
      }

      .label {
        display: block;
        margin: 0 0 8px;
        font-size: 14px;
        font-weight: 600;
        color: rgba(15,23,42,.72);
      }

      .input, .select {
        width: 100%;
        height: 52px;
        border-radius: 12px;
        border: 1px solid rgba(15,23,42,.14);
        background: rgba(255,255,255,.94);
        padding: 0 14px;
        font-size: 16px;
        outline: none;
        transition: box-shadow .18s ease, border-color .18s ease;
        color: rgba(15,23,42,.92);
      }

      .input::placeholder { color: rgba(15,23,42,.34); }

      .input:focus, .select:focus {
        border-color: rgba(123,115,241,.55);
        box-shadow: 0 0 0 4px rgba(123,115,241,.14);
      }

      .row2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .docRow {
        display: grid;
        grid-template-columns: 44% 56%;
        gap: 12px;
      }

      .btn {
        margin-top: 14px;
        width: 100%;
        height: 56px;
        border: 0;
        border-radius: 12px;
        background: rgba(123,115,241,.95);
        color: #fff;
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 0.01em;
        box-shadow: 0 18px 38px rgba(123,115,241,.30);
        cursor: pointer;
        transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease;
      }

      .btn:hover {
        transform: translateY(-1px);
        background: rgba(123,115,241,1);
        box-shadow: 0 22px 46px rgba(123,115,241,.36);
      }

      .btn:active { transform: translateY(0); }

      .btn[disabled] {
        opacity: .7;
        cursor: not-allowed;
        box-shadow: none;
      }

      .fine {
        margin-top: 10px;
        text-align: center;
        color: rgba(15,23,42,.42);
        font-size: 15px;
        font-weight: 500;
      }

      .alert {
        margin-top: 12px;
        border-radius: 12px;
        padding: 12px 12px;
        font-size: 14px;
        line-height: 1.35;
        display: none;
        border: 1px solid rgba(15,23,42,.10);
        background: rgba(255,255,255,.8);
      }
      .alert.show { display: block; }
      .alert.bad {
        border-color: rgba(239, 68, 68, 0.28);
        background: rgba(239, 68, 68, 0.08);
        color: rgba(127, 29, 29, 0.92);
      }

      .spinner {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 2px solid rgba(255,255,255,.35);
        border-top-color: rgba(255,255,255,.95);
        display: none;
        animation: spin .85s linear infinite;
        vertical-align: middle;
        margin-left: 10px;
      }

      @keyframes spin { to { transform: rotate(360deg); } }

      @media (max-width: 360px) {
        .title { font-size: 22px; }
        .docRow { grid-template-columns: 46% 54%; }
      }
    </style>
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-K9TFCGX9"
        height="0"
        width="0"
        style="display:none;visibility:hidden"
      ></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="topline"></div>

    <div class="wrap">
      <div class="phone">
        <div class="nav" aria-label="Topo">
          <svg class="lock" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 11V8.8C7 6.15 9.15 4 11.8 4h.4C14.85 4 17 6.15 17 8.8V11" stroke="rgba(15,23,42,.6)" stroke-width="2" stroke-linecap="round"/>
            <path d="M6.7 11h10.6c.9 0 1.7.8 1.7 1.7v6.6c0 .9-.8 1.7-1.7 1.7H6.7c-.9 0-1.7-.8-1.7-1.7v-6.6c0-.9.8-1.7 1.7-1.7Z" stroke="rgba(15,23,42,.6)" stroke-width="2"/>
          </svg>
          <span>Affect Ai</span>
        </div>

        <div class="summary" aria-label="Resumo">
          <div class="summaryRow">
            <span id="productName">AffectAI Anual</span>
            <strong id="productPrice">R$ 108,00</strong>
          </div>
          <div class="divider"></div>
          <div class="summaryRow">
            <strong>Total</strong>
            <strong id="totalPrice">108,00</strong>
          </div>
        </div>

        <div class="title">Preencha os dados do seu cartão</div>

        <div class="card" aria-label="Cartão">
          <form id="cardForm">
            <div class="field">
              <label class="label" for="cardNumber">Número do cartão</label>
              <input class="input" id="cardNumber" name="cardNumber" type="text" inputmode="numeric" autocomplete="cc-number" placeholder="1234 1234 1234 1234" required />
            </div>

            <div class="field">
              <label class="label" for="cardholderName">Nome do titular</label>
              <input class="input" id="cardholderName" name="cardholderName" type="text" autocomplete="cc-name" placeholder="Ex.: Maria Lopes" required />
            </div>

            <div class="row2">
              <div class="field">
                <label class="label" for="expiration">Vencimento</label>
                <input class="input" id="expiration" name="expiration" type="text" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/AA" required />
              </div>

              <div class="field">
                <label class="label" for="cvv">Código de segurança</label>
                <input class="input" id="cvv" name="cvv" type="password" inputmode="numeric" autocomplete="cc-csc" placeholder="Ex.: 123" required />
              </div>
            </div>

            <div class="field" style="margin-top: 2px;">
              <label class="label" for="docType">Documento do titular</label>
              <div class="docRow">
                <select class="select" id="docType" name="docType" required>
                  <option value="CPF">CPF</option>
                  <option value="CNPJ">CNPJ</option>
                </select>
                <input class="input" id="docNumber" name="docNumber" type="text" inputmode="numeric" autocomplete="off" placeholder="999.999.999-99" required />
              </div>
            </div>

            <button class="btn" id="continueBtn" type="submit">
              <span id="btnText">Continuar</span>
              <span class="spinner" id="spin" aria-hidden="true"></span>
            </button>

            <div class="alert" id="alert"></div>

            <div class="fine">Você pode cancelar quando quiser</div>
          </form>
        </div>
      </div>
    </div>

    <script>
      const CONFIG = {
        MP_PUBLIC_KEY: "APP_USR-6c3829de-de42-45c0-9689-cd002aaf558b",
        NEXT_URL: "/checkout-email.html",
        PLAN_IDS: {
          month: "e9af351c59244681a3cd183596308cf4",
          year: "2bed7dc251154df4a67a026781712a35"
        }
      };

      const $ = (id) => document.getElementById(id);

      const form = $("cardForm");
      const cardNumberEl = $("cardNumber");
      const nameEl = $("cardholderName");
      const expEl = $("expiration");
      const cvvEl = $("cvv");
      const docTypeEl = $("docType");
      const docEl = $("docNumber");

      const btn = $("continueBtn");
      const btnText = $("btnText");
      const spin = $("spin");
      const alertEl = $("alert");

      const mp = new MercadoPago(CONFIG.MP_PUBLIC_KEY, { locale: "pt-BR" });

      function showAlert(msg) {
        alertEl.className = "alert show bad";
        alertEl.textContent = msg;
      }

      function clearAlert() {
        alertEl.className = "alert";
        alertEl.textContent = "";
      }

      function setLoading(on) {
        btn.disabled = on;
        spin.style.display = on ? "inline-block" : "none";
        btnText.textContent = on ? "Processando" : "Continuar";
      }

      function onlyDigits(s) { return (s || "").replace(/\D+/g, ""); }

      function formatCardNumber(v) {
        const d = onlyDigits(v).slice(0, 19);
        const parts = [];
        for (let i = 0; i < d.length; i += 4) parts.push(d.slice(i, i + 4));
        return parts.join(" ");
      }

      function formatExpiration(v) {
        const d = onlyDigits(v).slice(0, 4);
        if (d.length <= 2) return d;
        return d.slice(0, 2) + "/" + d.slice(2);
      }

      function parseExp(mmYY) {
        const clean = onlyDigits(mmYY);
        const mm = clean.slice(0, 2);
        const yy = clean.slice(2, 4);
        if (mm.length !== 2 || yy.length !== 2) return null;
        const m = Number(mm);
        if (!m || m < 1 || m > 12) return null;
        return { month: String(m), year: String(2000 + Number(yy)) };
      }

      function formatDocPlaceholder() {
        docEl.placeholder = docTypeEl.value === "CPF" ? "999.999.999-99" : "99.999.999/9999-99";
      }

      function normalizeDocValue() {
        const max = docTypeEl.value === "CPF" ? 11 : 14;
        docEl.value = onlyDigits(docEl.value).slice(0, max);
      }

      function last4FromCard() {
        const d = onlyDigits(cardNumberEl.value);
        return d.length >= 4 ? d.slice(-4) : "";
      }

      async function detectPaymentMethod(bin) {
        try {
          if (!bin || bin.length < 6) return null;
          const res = await mp.getPaymentMethods({ bin });
          const pm = res && res.results && res.results[0] ? res.results[0] : null;
          if (!pm) return null;
          return {
            id: pm.id || "",
            name: pm.name || "",
            thumbnail: pm.thumbnail || "",
            payment_type_id: pm.payment_type_id || ""
          };
        } catch {
          return null;
        }
      }

      cardNumberEl.addEventListener("input", async (e) => {
        e.target.value = formatCardNumber(e.target.value);

        const digits = onlyDigits(e.target.value);
        if (digits.length >= 6) {
          const bin = digits.slice(0, 6);
          const pm = await detectPaymentMethod(bin);
          if (pm) sessionStorage.setItem("affectai_pm", JSON.stringify(pm));
        }
      });

      expEl.addEventListener("input", (e) => { e.target.value = formatExpiration(e.target.value); });

      docEl.addEventListener("input", () => { normalizeDocValue(); });

      docTypeEl.addEventListener("change", () => {
        formatDocPlaceholder();
        normalizeDocValue();
      });

      formatDocPlaceholder();

      function getSelectedPlanFromStorage() {
        const plan = sessionStorage.getItem("affectai_plan") || "year";
        return plan === "month" ? "month" : "year";
      }

      function setPlanSummaryUI() {
        const plan = getSelectedPlanFromStorage();
        const productNameEl = $("productName");
        const productPriceEl = $("productPrice");
        const totalPriceEl = $("totalPrice");

        if (plan === "month") {
          productNameEl.textContent = "AffectAI Mensal";
          productPriceEl.textContent = "R$ 27,00";
          totalPriceEl.textContent = "27,00";
        } else {
          productNameEl.textContent = "AffectAI Anual";
          productPriceEl.textContent = "R$ 108,00";
          totalPriceEl.textContent = "108,00";
        }
      }

      setPlanSummaryUI();

      async function createCardToken() {
        const exp = parseExp(expEl.value);
        if (!exp) throw new Error("Vencimento inválido. Use MM/AA.");

        const payload = {
          cardNumber: onlyDigits(cardNumberEl.value),
          cardholderName: nameEl.value.trim(),
          cardExpirationMonth: exp.month,
          cardExpirationYear: exp.year,
          securityCode: onlyDigits(cvvEl.value),
          identificationType: docTypeEl.value,
          identificationNumber: onlyDigits(docEl.value)
        };

        const result = await mp.createCardToken(payload);

        if (result && result.error) {
          const msg = (result.error && result.error.message) ? result.error.message : "Não foi possível validar o cartão.";
          throw new Error(msg);
        }

        if (!result || !result.id) throw new Error("Token não gerado. Revise os dados.");
        return result.id;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearAlert();

        if (!nameEl.value.trim()) return showAlert("Preencha o nome do titular.");
        if (onlyDigits(cardNumberEl.value).length < 13) return showAlert("Preencha o número do cartão.");
        if (!parseExp(expEl.value)) return showAlert("Preencha o vencimento no formato MM/AA.");
        if (onlyDigits(cvvEl.value).length < 3) return showAlert("Preencha o código de segurança.");
        if (docTypeEl.value === "CPF" && onlyDigits(docEl.value).length !== 11) return showAlert("CPF inválido.");
        if (docTypeEl.value === "CNPJ" && onlyDigits(docEl.value).length !== 14) return showAlert("CNPJ inválido.");

        setLoading(true);

        try {
          const plan = getSelectedPlanFromStorage();
          const preapproval_plan_id = CONFIG.PLAN_IDS[plan];

          const token = await createCardToken();

          const pm = sessionStorage.getItem("affectai_pm");
          const last4 = last4FromCard();

          sessionStorage.setItem("affectai_token", token);
          sessionStorage.setItem("affectai_plan_final", plan);
          sessionStorage.setItem("affectai_plan_id", preapproval_plan_id);
          sessionStorage.setItem("affectai_last4", last4);
          sessionStorage.setItem("affectai_docType", docTypeEl.value);
          sessionStorage.setItem("affectai_docNumber", onlyDigits(docEl.value));
          sessionStorage.setItem("affectai_name", nameEl.value.trim());
          if (pm) sessionStorage.setItem("affectai_pm", pm);

          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({ event: "checkout_card_continue", plan });

          window.location.href = CONFIG.NEXT_URL;
        } catch (err) {
          setLoading(false);
          const msg = (err && err.message) ? err.message : "Erro ao processar. Tente novamente.";
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({ event: "checkout_error", step: "card", message: msg });
          showAlert(msg);
        }
      });
    </script>
  </body>
</html>
```
