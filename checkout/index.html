<!doctype html>
<html lang="pt-br">
<head>
  <!-- Google Tag Manager -->
  <script>
    (function (w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
      j.async = true;
      j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-K9TFCGX9');
  </script>
  <!-- End Google Tag Manager -->

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Affect AI | Checkout</title>

  <script src="https://sdk.mercadopago.com/js/v2"></script>

  <style>
    :root{
      --purple:#7b73f1;
      --bg:#070710;
      --panel:#0b0b16;
      --panel2:#0d0d1c;
      --text:#eef0ff;
      --muted:#a9a7c9;
      --line:rgba(255,255,255,.10);
      --shadow:0 24px 70px rgba(0,0,0,.45);
      --radius:22px;
      --radius2:16px;
      --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif;
      --ok:#36d399;
      --warn:#fbbf24;
      --bad:#fb7185;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(123,115,241,.22), transparent 60%),
        radial-gradient(800px 520px at 80% 20%, rgba(123,115,241,.16), transparent 60%),
        radial-gradient(700px 520px at 55% 85%, rgba(255,255,255,.06), transparent 55%),
        linear-gradient(180deg, var(--bg), #05050c);
      overflow-x:hidden;
    }

    a{color:inherit}
    .wrap{max-width:1120px;margin:0 auto;padding:28px 18px 40px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:10px 2px 18px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;min-width:220px;
      user-select:none;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:
        radial-gradient(16px 16px at 30% 28%, rgba(255,255,255,.40), transparent 70%),
        linear-gradient(135deg, rgba(123,115,241,1), rgba(123,115,241,.55));
      box-shadow:0 18px 40px rgba(123,115,241,.20);
      border:1px solid rgba(255,255,255,.14);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute;inset:10px;
      border-radius:10px;
      background:rgba(10,10,22,.35);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
    }
    .brand h1{
      margin:0;
      font-size:14px;
      letter-spacing:.18em;
      text-transform:uppercase;
      opacity:.95;
    }
    .brand span{
      display:block;
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.02em;
      text-transform:none;
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--ok);box-shadow:0 0 0 5px rgba(54,211,153,.12)}

    .hero{
      margin-top:6px;
      display:flex;align-items:flex-end;justify-content:space-between;gap:16px;
    }
    .hero h2{
      margin:0;
      font-size:28px;
      letter-spacing:-.02em;
    }
    .hero p{
      margin:10px 0 0;
      color:var(--muted);
      max-width:720px;
      line-height:1.45;
      font-size:14px;
    }

    .grid{
      margin-top:22px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .pill{display:none}
    }

    .card{
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:
        radial-gradient(700px 320px at 20% 0%, rgba(123,115,241,.16), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:18px 18px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .cardHead strong{font-size:14px;letter-spacing:.02em}
    .cardBody{padding:18px}

    .planSwitch{
      display:flex;gap:8px;
      padding:6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,10,22,.45);
    }
    .planBtn{
      appearance:none;border:0;cursor:pointer;
      padding:10px 12px;border-radius:999px;
      color:var(--muted);
      background:transparent;
      font-weight:700;
      font-size:12px;
      letter-spacing:.02em;
      transition:transform .12s ease, background .12s ease, color .12s ease;
    }
    .planBtn:active{transform:scale(.98)}
    .planBtn.active{
      background:rgba(123,115,241,.20);
      color:var(--text);
      box-shadow:0 10px 30px rgba(123,115,241,.18);
      border:1px solid rgba(123,115,241,.30);
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 640px){
      .formGrid{grid-template-columns:1fr}
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 8px;
      letter-spacing:.02em;
    }

    .field{
      position:relative;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(6,6,14,.55);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      overflow:hidden;
    }
    .field input, .field select{
      width:100%;
      background:transparent;
      border:0;
      color:var(--text);
      padding:14px 14px;
      outline:none;
      font-size:14px;
    }
    .field input::placeholder{color:rgba(169,167,201,.65)}
    .field:focus-within{
      border-color:rgba(123,115,241,.55);
      box-shadow:0 0 0 4px rgba(123,115,241,.14), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .hint{
      margin-top:8px;
      font-size:12px;
      color:rgba(169,167,201,.85);
      line-height:1.35;
    }

    .divider{
      height:1px;background:rgba(255,255,255,.08);
      margin:16px 0;
    }

    .cta{
      margin-top:14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .btn{
      appearance:none;border:0;cursor:pointer;
      padding:14px 16px;
      border-radius:16px;
      font-weight:800;
      letter-spacing:.02em;
      font-size:14px;
      color:#0a0a16;
      background: linear-gradient(135deg, rgba(255,255,255, .92), rgba(123,115,241, .75));
      box-shadow:0 18px 46px rgba(123,115,241,.22);
      min-width:220px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:transform .12s ease, filter .12s ease;
    }
    .btn:active{transform:scale(.99)}
    .btn[disabled]{
      cursor:not-allowed;
      filter:grayscale(.25) opacity(.70);
      box-shadow:none;
    }

    .btnGhost{
      appearance:none;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:14px 16px;
      border-radius:16px;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
    }
    .btnGhost:active{transform:scale(.99)}

    .tiny{
      font-size:12px;color:var(--muted);
      line-height:1.35;
    }

    .summaryLine{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.07);
      font-size:14px;
    }
    .summaryLine:last-child{border-bottom:0}
    .k{color:var(--muted);font-size:12px;letter-spacing:.02em}
    .v{font-weight:800}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      font-size:12px;color:rgba(238,240,255,.92);
    }
    .badge b{color:var(--ok)}
    .badge .i{
      width:8px;height:8px;border-radius:99px;background:var(--ok);
      box-shadow:0 0 0 5px rgba(54,211,153,.10);
    }

    .alert{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      padding:12px 12px;
      font-size:13px;
      line-height:1.35;
      color:rgba(238,240,255,.92);
      display:none;
    }
    .alert.ok{border-color:rgba(54,211,153,.35);background:rgba(54,211,153,.10)}
    .alert.bad{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10)}
    .alert.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.08)}
    .alert.show{display:block}

    .spinner{
      width:16px;height:16px;border-radius:99px;
      border:2px solid rgba(10,10,22,.35);
      border-top-color:rgba(10,10,22,.9);
      animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .lockrow{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      margin-top:10px;
    }
    .lock{
      width:34px;height:34px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      display:grid;place-items:center;
      color:rgba(238,240,255,.90);
      flex:0 0 auto;
    }
    .lock svg{opacity:.9}
    footer{
      margin-top:18px;
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
      color:rgba(169,167,201,.75);
      font-size:12px;
    }
  </style>
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K9TFCGX9"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>AFFECT AI</h1>
          <span>Checkout transparente com Mercado Pago</span>
        </div>
      </div>

      <div class="pill" title="Ambiente seguro">
        <span class="dot" aria-hidden="true"></span>
        Pagamento seguro
      </div>
    </div>

    <div class="hero">
      <div>
        <h2>Finalize sua assinatura</h2>
        <p>Cartão de crédito no próprio site. Sem redirecionamento. Tracking perfeito via GTM.</p>
      </div>

      <div class="planSwitch" role="group" aria-label="Escolher plano">
        <button class="planBtn active" id="btnMonthly" type="button">Mensal R$ 9</button>
        <button class="planBtn" id="btnAnnual" type="button">Anual R$ 108</button>
      </div>
    </div>

    <div class="grid">
      <!-- Checkout -->
      <div class="card">
        <div class="cardHead">
          <strong>Dados do pagamento</strong>
          <span class="badge"><span class="i" aria-hidden="true"></span><b>Transparente</b> no site</span>
        </div>

        <div class="cardBody">
          <form id="form-checkout" autocomplete="on">
            <div class="formGrid">
              <div>
                <label for="payerEmail">E-mail</label>
                <div class="field">
                  <input id="payerEmail" name="payerEmail" type="email" inputmode="email" placeholder="seuemail@exemplo.com" required />
                </div>
              </div>

              <div>
                <label for="cardholderName">Nome no cartão</label>
                <div class="field">
                  <input id="form-checkout__cardholderName" name="cardholderName" type="text" placeholder="Como está no cartão" required />
                </div>
              </div>

              <div>
                <label for="cardNumber">Número do cartão</label>
                <div class="field">
                  <input id="form-checkout__cardNumber" name="cardNumber" type="text" inputmode="numeric" placeholder="0000 0000 0000 0000" required />
                </div>
              </div>

              <div>
                <label for="expirationDate">Validade</label>
                <div class="field">
                  <input id="form-checkout__expirationDate" name="expirationDate" type="text" inputmode="numeric" placeholder="MM/AA" required />
                </div>
              </div>

              <div>
                <label for="securityCode">CVV</label>
                <div class="field">
                  <input id="form-checkout__securityCode" name="securityCode" type="password" inputmode="numeric" placeholder="123" required />
                </div>
              </div>

              <div>
                <label for="installments">Parcelas</label>
                <div class="field">
                  <select id="form-checkout__installments" name="installments" required>
                    <option value="">Carregando...</option>
                  </select>
                </div>
              </div>

              <div>
                <label for="identificationType">Documento</label>
                <div class="field">
                  <select id="form-checkout__identificationType" name="identificationType" required></select>
                </div>
              </div>

              <div>
                <label for="identificationNumber">Número do documento</label>
                <div class="field">
                  <input id="form-checkout__identificationNumber" name="identificationNumber" type="text" inputmode="numeric" placeholder="CPF ou CNPJ" required />
                </div>
              </div>

              <div>
                <label for="issuer">Banco emissor</label>
                <div class="field">
                  <select id="form-checkout__issuer" name="issuer" required></select>
                </div>
              </div>

              <div>
                <label for="cardNetwork">Bandeira</label>
                <div class="field">
                  <input id="cardNetwork" type="text" placeholder="Detectada automaticamente" disabled />
                </div>
              </div>
            </div>

            <div class="hint">
              Ao clicar em pagar, os dados do cartão são tokenizados pelo Mercado Pago. Seu servidor recebe apenas o token.
            </div>

            <div class="divider"></div>

            <div class="cta">
              <button class="btn" id="payBtn" type="submit">
                <span id="payBtnText">Pagar e ativar agora</span>
                <span id="payBtnSpin" class="spinner" style="display:none" aria-hidden="true"></span>
              </button>

              <button class="btnGhost" id="backBtn" type="button">Voltar</button>

              <div class="tiny">
                <div class="lockrow">
                  <span class="lock" aria-hidden="true">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                      <path d="M7 11V8a5 5 0 0 1 10 0v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      <path d="M6 11h12a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                  </span>
                  <span>Ambiente criptografado. Você pode cancelar quando quiser.</span>
                </div>
              </div>
            </div>

            <div id="alert" class="alert"></div>
          </form>
        </div>
      </div>

      <!-- Resumo -->
      <div class="card">
        <div class="cardHead">
          <strong>Resumo</strong>
          <span class="k" id="planLabelTop">Plano Mensal</span>
        </div>
        <div class="cardBody">
          <div class="summaryLine">
            <div>
              <div class="k">Produto</div>
              <div class="v">Affect AI</div>
            </div>
            <div class="k">Assinatura</div>
          </div>

          <div class="summaryLine">
            <div>
              <div class="k">Plano</div>
              <div class="v" id="planName">Mensal</div>
            </div>
            <div class="v" id="planPrice">R$ 9,00</div>
          </div>

          <div class="summaryLine">
            <div>
              <div class="k">Recorrência</div>
              <div class="v" id="planRecurrence">Todo mês</div>
            </div>
            <div class="badge" title="Cobrança recorrente">
              <span class="i" aria-hidden="true"></span>Renovação automática
            </div>
          </div>

          <div class="divider"></div>

          <div class="summaryLine">
            <div>
              <div class="k">Total agora</div>
              <div class="v">Pagamento</div>
            </div>
            <div class="v" id="totalNow">R$ 9,00</div>
          </div>

          <div id="summaryAlert" class="alert warn show" style="display:block">
            Dica: se o usuário veio do anúncio, mantenha esta página leve. Evite popups e redirecionamentos.
          </div>

          <footer>
            <div>© <span id="year"></span> Affect AI</div>
            <div>Processado por Mercado Pago</div>
          </footer>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIGURAÇÃO
    // =========================
    const MP_PUBLIC_KEY = "COLOQUE_SUA_PUBLIC_KEY_AQUI";

    // Endpoint do seu backend (Cloudflare Worker, Node, etc).
    // Esse endpoint deve receber: { plan, amount, payerEmail, token, ...cardFormData }
    // e criar pagamento/assinatura no Mercado Pago.
    const BACKEND_ENDPOINT = "/api/mp/subscribe";

    // URLs de obrigado (ajuste para as suas)
    const THANK_YOU_MONTHLY = "/obrigado-mensal.html";
    const THANK_YOU_ANNUAL  = "/obrigado-anual.html";

    // Seus valores
    const PLANS = {
      monthly: { label: "Mensal", amount: 9.00, recurrence: "Todo mês", thankyou: THANK_YOU_MONTHLY },
      annual:  { label: "Anual",  amount: 108.00, recurrence: "Todo ano", thankyou: THANK_YOU_ANNUAL }
    };

    // =========================
    // UI E ESTADO
    // =========================
    const $ = (id) => document.getElementById(id);

    const btnMonthly = $("btnMonthly");
    const btnAnnual  = $("btnAnnual");
    const planLabelTop = $("planLabelTop");
    const planName = $("planName");
    const planPrice = $("planPrice");
    const planRecurrence = $("planRecurrence");
    const totalNow = $("totalNow");
    const yearEl = $("year");
    const alertEl = $("alert");

    const payBtn = $("payBtn");
    const payBtnText = $("payBtnText");
    const payBtnSpin = $("payBtnSpin");
    const backBtn = $("backBtn");

    const payerEmailEl = $("payerEmail");
    const cardNetworkEl = $("cardNetwork");

    yearEl.textContent = new Date().getFullYear();

    let currentPlan = "monthly";

    function formatBRL(v){
      try{
        return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
      }catch(e){
        return "R$ " + String(v).replace(".",",");
      }
    }

    function setPlan(planKey){
      currentPlan = planKey;
      const p = PLANS[planKey];

      btnMonthly.classList.toggle("active", planKey === "monthly");
      btnAnnual.classList.toggle("active", planKey === "annual");

      planLabelTop.textContent = "Plano " + p.label;
      planName.textContent = p.label;
      planPrice.textContent = formatBRL(p.amount);
      planRecurrence.textContent = p.recurrence;
      totalNow.textContent = formatBRL(p.amount);

      // Reconfigura cardForm com o novo amount para recalcular parcelas
      initCardForm(true);

      // Evento para tracking
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        event: "checkout_plan_selected",
        plan: planKey,
        value: p.amount
      });
    }

    btnMonthly.addEventListener("click", () => setPlan("monthly"));
    btnAnnual.addEventListener("click", () => setPlan("annual"));

    backBtn.addEventListener("click", () => {
      history.back();
    });

    function showAlert(type, msg){
      alertEl.className = "alert show " + type;
      alertEl.textContent = msg;
    }
    function clearAlert(){
      alertEl.className = "alert";
      alertEl.textContent = "";
    }

    function setLoading(isLoading){
      payBtn.disabled = isLoading;
      payBtnSpin.style.display = isLoading ? "inline-block" : "none";
      payBtnText.textContent = isLoading ? "Processando..." : "Pagar e ativar agora";
    }

    // =========================
    // MERCADO PAGO CARD FORM
    // =========================
    let mp;
    let cardForm;

    function guessCardNetworkFromFirstDigits(value){
      const v = (value || "").replace(/\s+/g,"");
      if(!v) return "";
      if(/^4/.test(v)) return "Visa";
      if(/^(5[1-5])/.test(v)) return "Mastercard";
      if(/^(3[47])/.test(v)) return "American Express";
      if(/^(6)/.test(v)) return "Elo ou Hipercard";
      return "Detectando...";
    }

    function initCardForm(forceRebuild){
      const plan = PLANS[currentPlan];

      if(!mp){
        mp = new MercadoPago(MP_PUBLIC_KEY, { locale: "pt-BR" });
      }

      if(cardForm && forceRebuild){
        try{ cardForm.unmount(); }catch(e){}
        cardForm = null;
      }
      if(cardForm) return;

      cardForm = mp.cardForm({
        amount: String(plan.amount.toFixed(2)),
        form: {
          id: "form-checkout",
          cardholderName: { id: "form-checkout__cardholderName", placeholder: "Como está no cartão" },
          cardNumber: { id: "form-checkout__cardNumber", placeholder: "0000 0000 0000 0000" },
          expirationDate: { id: "form-checkout__expirationDate", placeholder: "MM/AA" },
          securityCode: { id: "form-checkout__securityCode", placeholder: "123" },
          installments: { id: "form-checkout__installments", placeholder: "Parcelas" },
          identificationType: { id: "form-checkout__identificationType", placeholder: "Tipo" },
          identificationNumber: { id: "form-checkout__identificationNumber", placeholder: "Número" },
          issuer: { id: "form-checkout__issuer", placeholder: "Banco emissor" }
        },
        callbacks: {
          onFormMounted: (error) => {
            if (error){
              showAlert("bad", "Erro ao carregar o checkout. Verifique sua Public Key e tente novamente.");
              console.error(error);
            }
          },
          onSubmit: async (event) => {
            event.preventDefault();
            clearAlert();

            const payerEmail = payerEmailEl.value.trim();
            if(!payerEmail){
              showAlert("warn","Preencha seu e-mail.");
              return;
            }

            setLoading(true);

            try{
              const data = cardForm.getCardFormData();

              // data.token é o card_token
              if(!data.token){
                showAlert("bad","Não foi possível tokenizar o cartão. Revise os dados.");
                setLoading(false);
                return;
              }

              // Evento GTM antes de enviar
              window.dataLayer = window.dataLayer || [];
              window.dataLayer.push({
                event: "checkout_submit",
                plan: currentPlan,
                value: plan.amount
              });

              const payload = {
                plan: currentPlan,
                amount: plan.amount,
                payerEmail,
                mp: {
                  token: data.token,
                  payment_method_id: data.paymentMethodId,
                  issuer_id: data.issuerId,
                  installments: Number(data.installments),
                  identificationType: data.identificationType,
                  identificationNumber: data.identificationNumber
                }
              };

              const res = await fetch(BACKEND_ENDPOINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
              });

              const out = await res.json().catch(() => ({}));

              if(!res.ok){
                const msg = out && out.message ? out.message : "Falha ao processar. Tente novamente.";
                showAlert("bad", msg);
                window.dataLayer.push({
                  event: "checkout_error",
                  plan: currentPlan,
                  value: plan.amount,
                  message: msg
                });
                setLoading(false);
                return;
              }

              // Aqui você decide o que o backend retorna.
              // Sugestão: { status: "approved" } ou { status: "pending" } etc.
              const status = out.status || "approved";

              if(status === "approved" || status === "authorized"){
                showAlert("ok","Pagamento aprovado. Redirecionando...");
                window.dataLayer.push({
                  event: "purchase",
                  plan: currentPlan,
                  value: plan.amount,
                  currency: "BRL",
                  transaction_id: out.transaction_id || out.id || ""
                });

                setTimeout(() => {
                  window.location.href = plan.thankyou;
                }, 700);
                return;
              }

              if(status === "in_process" || status === "pending"){
                showAlert("warn","Pagamento em análise. Você receberá a confirmação por e-mail.");
                window.dataLayer.push({
                  event: "checkout_pending",
                  plan: currentPlan,
                  value: plan.amount,
                  transaction_id: out.transaction_id || out.id || ""
                });

                setTimeout(() => {
                  window.location.href = plan.thankyou;
                }, 900);
                return;
              }

              showAlert("bad","Pagamento recusado. Tente outro cartão.");
              window.dataLayer.push({
                event: "checkout_refused",
                plan: currentPlan,
                value: plan.amount
              });
              setLoading(false);

            }catch(err){
              console.error(err);
              showAlert("bad","Erro inesperado. Tente novamente.");
              window.dataLayer = window.dataLayer || [];
              window.dataLayer.push({
                event: "checkout_error",
                plan: currentPlan,
                value: PLANS[currentPlan].amount,
                message: "unexpected_error"
              });
              setLoading(false);
            }
          },
          onFetching: (resource) => {
            // dispara quando MP busca parcelas, emissores, etc.
            // bom para tracking de qualidade
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
              event: "mp_fetching",
              resource: resource,
              plan: currentPlan
            });
          }
        }
      });

      // Bandeira básica (não é oficial do MP, só UX)
      const cardNumberInput = $("form-checkout__cardNumber");
      cardNumberInput.addEventListener("input", (e) => {
        cardNetworkEl.value = guessCardNetworkFromFirstDigits(e.target.value);
      });
    }

    // Boot
    setPlan("monthly");
    initCardForm(false);
  </script>
</body>
</html>
